class e{constructor(e){this.defaults={baseUrl:"",header:{"content-type":"application/json"},method:"GET",dataType:"json",responseType:"text",custom:{}},this.interceptor={request:e=>{e&&(this.requestBeforeFun=e)},response:(e,t)=>{e&&(this.requestComFun=e),t&&(this.requestComFail=t)}},this.defaults=Object.assign({},this.defaults,e)}requestBeforeFun(e,t){return e}requestComFun(e){return e}requestComFail(e){return e}validateStatus(e){return 200===e}handler(t,s){let r={};return r.method=t.method||this.defaults.method,r.baseUrl=this.defaults.baseUrl,r.url=t.url||"",r.params=t.params||{},r.data=t.data||{},r.header=Object.assign({},this.defaults.header,t.header||{}),r.dataType=t.dataType||this.defaults.dataType,r.responseType=t.responseType||this.defaults.responseType,r.timeout=t.timeout||this.defaults.timeout,r.filePath=t.filePath||"",r.fileName=t.fileName||"file",r.onUploadProgress=t.onUploadProgress,r.getTask=t.getTask||this.defaults.getTask,r.loading=t.loading||!1,r.custom=Object.assign({},this.defaults.custom,t.custom||{}),r.onError=t.onError,new Promise((t,a)=>{let o=!0;const n=this.requestBeforeFun(r,(e="handle cancel",t=r)=>{a({errMsg:e,config:t}),o=!1});o&&(n.loading&&wx.showLoading({title:"加载中..."}),n.path=e.mergeUrl(n.url,n.baseUrl,n.params),s(n,t,a))})}handlerResult(e,t,s,r){e.config=t,this.validateStatus(e.statusCode)?(e=this.requestComFun(e),Promise.resolve().then(()=>e).then(e=>s(e)).catch(e=>r(e))):(e=this.requestComFail(e),r(e)),t.loading&&wx.hideLoading()}request(e){return this.handler(e,(e,t,s)=>{const r=wx.request({url:e.path,data:e.data,header:e.header,method:e.method,dataType:e.dataType,responseType:e.responseType,complete:r=>{this.handlerResult(r,e,t,s)}});e.getTask&&e.getTask(r,e)})}uploadFile(e){return this.handler(e,(e,t,s)=>{console.log(e);const r=wx.uploadFile({url:e.path,filePath:e.filePath,name:e.fileName,formData:e.data,header:e.header,complete:r=>{"json"==e.dataType&&(r.data=JSON.parse(r.data)),this.handlerResult(r,e,t,s)}});e.getTask&&e.getTask(r,e),e.onUploadProgress&&r.onProgressUpdate(e.onUploadProgress)})}downLoadFile(e){}get(e,t,s={}){return this.request(Object.assign({method:"GET",url:e+t},s))}post(e,t,s={}){return this.request(Object.assign({method:"POST",url:e,data:t},s))}upload(e,t,s){return this.uploadFile(Object.assign({url:e,filePath:t},s))}download(){}static posUrl(e){return/(http|https):\/\/([\w.]+\/?)\S*/.test(e)}static mergeUrl(t,s,r){let a=e.posUrl(t)?t:`${s}${t}`;if(0!==Object.keys(r).length){const t=e.addQueryString(r);a+=a.includes("?")?"&"+t:"?"+t}return a}static addQueryString(e){let t="";return Object.keys(e).forEach((function(s){t+=s+"="+encodeURIComponent(e[s])+"&"})),t.substring(0,t.length-1)}}class t{constructor(e,t){this.code=e,this.message=t}getCode(){return this.code}getMessage(){return this.message}}class s{constructor(e){this.status=e}isSuccess(){return 1===this.status.succeed}isError(){return 0===this.status.succeed}getError(){return this.isSuccess()?null:(this.error||(this.error=new ResponseError(this.status.error_code,this.status.error_desc)),this.error)}getErrorCode(){return this.getError()?this.getError().getCode():""}getErrorMessage(){return this.getError()?this.getError().getMessage():""}}class r{constructor(e){this.response=e}handler(e,t){const s=this.getStatus();return s.isError()?t(s):e(this)}getStatus(){return new s(this.getBody().status)}getData(){return this.getBody().data}getPaginated(){return this.getBody().paginated}getBody(){return this.getResponse().data}getHeader(){return this.getResponse().header}getCookies(){return this.getResponse().cookies}getResponse(){return this.response}getConfig(){return this.getResponse().config}}export default e;export{e as Request,r as Response,t as ResponseError,s as ResponseStatus};
