function e(e,t,a={}){let s=function(e){return/(http|https):\/\/([\w.]+\/?)\S*/.test(e)}(t)?t:`${e}${t}`;if(0!==Object.keys(a).length){const e=function(e){let t="";return Object.keys(e).forEach((function(a){t+=a+"="+encodeURIComponent(e[a])+"&"})),t.substring(0,t.length-1)}(a);s+=s.includes("?")?"&"+e:"?"+e}return s}export default class{constructor(e={}){let t={};t.baseUrl=e.baseUrl||"",t.method=e.method||"GET",t.dataType=e.dataType||"json",t.responseType=e.responseType||"text",t.fileName=e.fileName||"file",t.showLoading=e.showLoading||!1,t.header={"content-type":"application/json",...e.header},t.custom=e.custom||{},this.defaults=t,this.interceptor={request:e=>{e&&(this._requestBeforeFun=e)},response:(e,t)=>{e&&(this._requestComFun=e),t&&(this._requestComFail=t)}}}_requestBeforeFun(e,t){return e}_requestComFun(e){return e}_requestComFail(e){return e}validateStatus(e){return 200===e}get(e,t={},a={}){return this.request(Object.assign({method:"GET",url:e,params:t},a))}post(e,t={},a){return this.request(Object.assign({method:"POST",url:e,data:t},a))}upload(e,t,a={}){return a.header=a.header||{},a.header["Content-Type"]||(a.header["Content-Type"]="multipart/form-data"),this.uploadFile(Object.assign({url:e,filePath:t},a))}download(){}request(e){return this.handler(e,(e,t,a)=>{const s=wx.request({url:e.path,data:e.data,header:e.header,method:e.method,dataType:e.dataType,responseType:e.responseType,complete:s=>{this.handlerResult(s,e,t,a)}});e.getTask&&e.getTask(s,e)})}uploadFile(e){return this.handler(e,(e,t,a)=>{const s=wx.uploadFile({url:e.path,filePath:e.filePath,name:e.fileName,formData:e.data,header:e.header,complete:s=>{"json"==e.dataType&&(s.data=JSON.parse(s.data)),this.handlerResult(s,e,t,a)}});e.getTask&&e.getTask(s,e),e.onUploadProgress&&s.onProgressUpdate(e.onUploadProgress)})}downLoadFile(e){}handler(t,a){let s={};return s.baseUrl=this.defaults.baseUrl,s.method=t.method||this.defaults.method,s.url=t.url||"",s.params=t.params||{},s.data=t.data||{},s.header=Object.assign({},this.defaults.header,t.header||{}),s.dataType=t.dataType||this.defaults.dataType,s.responseType=t.responseType||this.defaults.responseType,s.timeout=t.timeout||this.defaults.timeout,s.filePath=t.filePath||"",s.fileName=t.fileName||this.defaults.fileName,s.onUploadProgress=t.onUploadProgress,s.getTask=t.getTask||this.defaults.getTask,s.showLoading=t.showLoading||this.defaults.showLoading,s.custom=Object.assign({},this.defaults.custom,t.custom||{}),new Promise((t,r)=>{let o=!0;const n=this._requestBeforeFun(s,(e="handle cancel",t=s)=>{r({errMsg:e,config:t}),o=!1});o&&(n.showLoading&&wx.showLoading({title:"加载中..."}),n.path=e(n.baseUrl,n.url,n.params),a(n,t,r))})}handlerResult(e,t,a,s){e.config=t,this.validateStatus(e.statusCode)?(e=this._requestComFun(e),Promise.resolve().then(()=>e).then(e=>a(e)).catch(e=>s(e))):(e=this._requestComFail(e),s(e)),t.showLoading&&wx.hideLoading()}}
