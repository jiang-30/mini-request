function e(e,t,s={}){let a=function(e){return/(http|https):\/\/([\w.]+\/?)\S*/.test(e)}(t)?t:`${e}${t}`;if(0!==Object.keys(s).length){const e=function(e){let t="";return Object.keys(e).forEach((function(s){t+=s+"="+encodeURIComponent(e[s])+"&"})),t.substring(0,t.length-1)}(s);a+=a.includes("?")?"&"+e:"?"+e}return a}export default class{defaults={};constructor(e={}){this.defaults.baseUrl=e.baseUrl||"",this.defaults.method=e.method||"GET",this.defaults.dataType=e.dataType||"json",this.defaults.responseType=e.responseType||"text",this.defaults.fileName=e.fileName||"file",this.defaults.showLoading=e.showLoading||!1,this.defaults.header={"content-type":"application/json",...e.header},this.defaults.custom=e.custom||{}}interceptor={request:e=>{e&&(this._requestBeforeFun=e)},response:(e,t)=>{e&&(this._requestComFun=e),t&&(this._requestComFail=t)}};_requestBeforeFun(e,t){return e}_requestComFun(e){return e}_requestComFail(e){return e}validateStatus(e){return 200===e}get(e,t={},s={}){return this.request({method:"GET",url:e,params:t,...s})}post(e,t={},s){return this.request({method:"POST",url:e,data:t,...s})}upload(e,t,s={}){return s.header=s.header||{},s.header["Content-Type"]||(s.header["Content-Type"]="multipart/form-data"),this.uploadFile(Object.assign({},{url:e,filePath:t},s))}download(){}request(e){return this.handler(e,(e,t,s)=>{let a={url:e.path,data:e.data,header:e.header,method:e.method,dataType:e.dataType,responseType:e.responseType};const r=wx.request({...a,complete:a=>{this.handlerResult(a,e,t,s)}});e.getTask&&e.getTask(r,e)})}uploadFile(e){return this.handler(e,(e,t,s)=>{let a={url:e.path,filePath:e.filePath,name:e.fileName,formData:e.data,header:e.header};const r=wx.uploadFile({...a,complete:a=>{"json"==e.dataType&&(a.data=JSON.parse(a.data)),this.handlerResult(a,e,t,s)}});e.getTask&&e.getTask(r,e),e.onUploadProgress&&r.onProgressUpdate(e.onUploadProgress)})}downLoadFile(e){}handler(t,s){let a={};return a.baseUrl=this.defaults.baseUrl,a.method=t.method||this.defaults.method,a.url=t.url||"",a.params=t.params||{},a.data=t.data||{},a.header={...this.defaults.header,...t.header||{}},a.dataType=t.dataType||this.defaults.dataType,a.responseType=t.responseType||this.defaults.responseType,a.timeout=t.timeout||this.defaults.timeout,a.filePath=t.filePath||"",a.fileName=t.fileName||this.defaults.fileName,a.onUploadProgress=t.onUploadProgress,a.getTask=t.getTask||this.defaults.getTask,a.showLoading=t.showLoading||this.defaults.showLoading,a.custom={...this.defaults.custom,...t.custom||{}},new Promise((t,r)=>{let o=!0;const d=this._requestBeforeFun(a,(e="handle cancel",t=a)=>{r({errMsg:e,config:t}),o=!1});o&&(d.showLoading&&wx.showLoading({title:"加载中..."}),d.path=e(d.url,d.baseUrl,d.params),s(d,t,r))})}handlerResult(e,t,s,a){e.config=t,this.validateStatus(e.statusCode)?(e=this._requestComFun(e),Promise.resolve().then(()=>e).then(e=>s(e)).catch(e=>a(e))):(e=this._requestComFail(e),a(e)),t.showLoading&&wx.hideLoading()}}
